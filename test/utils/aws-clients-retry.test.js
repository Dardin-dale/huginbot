"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_clients_1 = require("../../lib/lambdas/utils/aws-clients");
describe('AWS Client Retry Logic Tests', () => {
    // Save and restore console.log/error
    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;
    beforeEach(() => {
        console.log = jest.fn();
        console.error = jest.fn();
    });
    afterEach(() => {
        console.log = originalConsoleLog;
        console.error = originalConsoleError;
    });
    it('should execute the operation successfully on first try', async () => {
        const mockOperation = jest.fn().mockResolvedValue('success');
        const result = await (0, aws_clients_1.withRetry)(mockOperation);
        expect(result).toBe('success');
        expect(mockOperation).toHaveBeenCalledTimes(1);
    });
    it('should retry the operation when it fails and succeed eventually', async () => {
        // Fail twice, succeed on third try
        const mockOperation = jest.fn()
            .mockRejectedValueOnce(new Error('Failure 1'))
            .mockRejectedValueOnce(new Error('Failure 2'))
            .mockResolvedValueOnce('success');
        // Mock setTimeout to execute immediately for faster tests
        jest.useFakeTimers();
        const originalSetTimeout = global.setTimeout;
        global.setTimeout = jest.fn((callback) => {
            callback();
            return {};
        });
        const result = await (0, aws_clients_1.withRetry)(mockOperation);
        expect(result).toBe('success');
        expect(mockOperation).toHaveBeenCalledTimes(3);
        // Restore setTimeout
        global.setTimeout = originalSetTimeout;
        jest.useRealTimers();
    });
    it('should throw an error after max retries', async () => {
        // Always fail
        const mockError = new Error('Persistent failure');
        const mockOperation = jest.fn().mockRejectedValue(mockError);
        // Mock setTimeout to execute immediately
        jest.useFakeTimers();
        const originalSetTimeout = global.setTimeout;
        global.setTimeout = jest.fn((callback) => {
            callback();
            return {};
        });
        await expect((0, aws_clients_1.withRetry)(mockOperation, 3)).rejects.toThrow(mockError);
        expect(mockOperation).toHaveBeenCalledTimes(3);
        // Restore setTimeout
        global.setTimeout = originalSetTimeout;
        jest.useRealTimers();
    });
    it('should respect custom maxRetries parameter', async () => {
        // Always fail
        const mockOperation = jest.fn().mockRejectedValue(new Error('Failure'));
        // Mock setTimeout to execute immediately
        jest.useFakeTimers();
        const originalSetTimeout = global.setTimeout;
        global.setTimeout = jest.fn((callback) => {
            callback();
            return {};
        });
        try {
            await (0, aws_clients_1.withRetry)(mockOperation, 5);
        }
        catch (error) {
            // Expected to fail
        }
        expect(mockOperation).toHaveBeenCalledTimes(5);
        // Restore setTimeout
        global.setTimeout = originalSetTimeout;
        jest.useRealTimers();
    });
    it('should use exponential backoff for delays between retries', async () => {
        const mockOperation = jest.fn()
            .mockRejectedValueOnce(new Error('Failure 1'))
            .mockRejectedValueOnce(new Error('Failure 2'))
            .mockResolvedValueOnce('success');
        const delays = [];
        const mockSetTimeout = jest.fn((callback, delay) => {
            delays.push(delay);
            callback();
            return {};
        });
        // Mock setTimeout to capture delay values
        jest.useFakeTimers();
        const originalSetTimeout = global.setTimeout;
        global.setTimeout = mockSetTimeout;
        await (0, aws_clients_1.withRetry)(mockOperation, 3, 100);
        expect(delays.length).toBe(2); // Two retries
        expect(delays[0]).toBe(100); // First retry: baseDelay * 2^0
        expect(delays[1]).toBe(200); // Second retry: baseDelay * 2^1
        // Restore setTimeout
        global.setTimeout = originalSetTimeout;
        jest.useRealTimers();
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXdzLWNsaWVudHMtcmV0cnkudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImF3cy1jbGllbnRzLXJldHJ5LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxRUFBZ0U7QUFFaEUsUUFBUSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtJQUM1QyxxQ0FBcUM7SUFDckMsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0lBQ3ZDLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztJQUUzQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsT0FBTyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDeEIsT0FBTyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxDQUFDLEdBQUcsR0FBRyxrQkFBa0IsQ0FBQztRQUNqQyxPQUFPLENBQUMsS0FBSyxHQUFHLG9CQUFvQixDQUFDO0lBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLHdEQUF3RCxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ3RFLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU3RCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsdUJBQVMsRUFBQyxhQUFhLENBQUMsQ0FBQztRQUU5QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQy9CLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqRCxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxpRUFBaUUsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMv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LCtCQUErQjtRQUM5RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUcsZ0NBQWdDO1FBRS9ELHFCQUFxQjtRQUNyQixNQUFNLENBQUMsVUFBVSxHQUFHLGtCQUFrQixDQUFDO1FBQ3ZDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgd2l0aFJldHJ5IH0gZnJvbSAnLi4vLi4vbGliL2xhbWJkYXMvdXRpbHMvYXdzLWNsaWVudHMnO1xuXG5kZXNjcmliZSgnQVdTIENsaWVudCBSZXRyeSBMb2dpYyBUZXN0cycsICgpID0+IHtcbiAgLy8gU2F2ZSBhbmQgcmVzdG9yZSBjb25zb2xlLmxvZy9lcnJvclxuICBjb25zdCBvcmlnaW5hbENvbnNvbGVMb2cgPSBjb25zb2xlLmxvZztcbiAgY29uc3Qgb3JpZ2luYWxDb25zb2xlRXJyb3IgPSBjb25zb2xlLmVycm9yO1xuICBcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY29uc29sZS5sb2cgPSBqZXN0LmZuKCk7XG4gICAgY29uc29sZS5lcnJvciA9IGplc3QuZm4oKTtcbiAgfSk7XG4gIFxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nID0gb3JpZ2luYWxDb25zb2xlTG9nO1xuICAgIGNvbnNvbGUuZXJyb3IgPSBvcmlnaW5hbENvbnNvbGVFcnJvcjtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBleGVjdXRlIHRoZSBvcGVyYXRpb24gc3VjY2Vzc2Z1bGx5IG9uIGZpcnN0IHRyeScsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2NrT3BlcmF0aW9uID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKCdzdWNjZXNzJyk7XG4gICAgXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgd2l0aFJldHJ5KG1vY2tPcGVyYXRpb24pO1xuICAgIFxuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoJ3N1Y2Nlc3MnKTtcbiAgICBleHBlY3QobW9ja09wZXJhdGlvbikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHJ5IHRoZSBvcGVyYXRpb24gd2hlbiBpdCBmYWlscyBhbmQgc3VjY2VlZCBldmVudHVhbGx5JywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEZhaWwgdHdpY2UsIHN1Y2NlZWQgb24gdGhpcmQgdHJ5XG4gICAgY29uc3QgbW9ja09wZXJhdGlvbiA9IGplc3QuZm4oKVxuICAgICAgLm1vY2tSZWplY3RlZFZhbHVlT25jZShuZXcgRXJyb3IoJ0ZhaWx1cmUgMScpKVxuICAgICAgLm1vY2tSZWplY3RlZFZhbHVlT25jZShuZXcgRXJyb3IoJ0ZhaWx1cmUgMicpKVxuICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZSgnc3VjY2VzcycpO1xuICAgIFxuICAgIC8vIE1vY2sgc2V0VGltZW91dCB0byBleGVjdXRlIGltbWVkaWF0ZWx5IGZvciBmYXN0ZXIgdGVzdHNcbiAgICBqZXN0LnVzZUZha2VUaW1lcnMoKTtcbiAgICBjb25zdCBvcmlnaW5hbFNldFRpbWVvdXQgPSBnbG9iYWwuc2V0VGltZW91dDtcbiAgICBnbG9iYWwuc2V0VGltZW91dCA9IGplc3QuZm4oKGNhbGxiYWNrKSA9PiB7XG4gICAgICBjYWxsYmFjaygpO1xuICAgICAgcmV0dXJuIHt9IGFzIGFueTtcbiAgICB9KSBhcyBhbnk7XG4gICAgXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgd2l0aFJldHJ5KG1vY2tPcGVyYXRpb24pO1xuICAgIFxuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoJ3N1Y2Nlc3MnKTtcbiAgICBleHBlY3QobW9ja09wZXJhdGlvbikudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDMpO1xuICAgIFxuICAgIC8vIFJlc3RvcmUgc2V0VGltZW91dFxuICAgIGdsb2JhbC5zZXRUaW1lb3V0ID0gb3JpZ2luYWxTZXRUaW1lb3V0O1xuICAgIGplc3QudXNlUmVhbFRpbWVycygpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGFmdGVyIG1heCByZXRyaWVzJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIEFsd2F5cyBmYWlsXG4gICAgY29uc3QgbW9ja0Vycm9yID0gbmV3IEVycm9yKCdQZXJzaXN0ZW50IGZhaWx1cmUnKTtcbiAgICBjb25zdCBtb2NrT3BlcmF0aW9uID0gamVzdC5mbigpLm1vY2tSZWplY3RlZFZhbHVlKG1vY2tFcnJvcik7XG4gICAgXG4gICAgLy8gTW9jayBzZXRUaW1lb3V0IHRvIGV4ZWN1dGUgaW1tZWRpYXRlbHlcbiAgICBqZXN0LnVzZUZha2VUaW1lcnMoKTtcbiAgICBjb25zdCBvcmlnaW5hbFNldFRpbWVvdXQgPSBnbG9iYWwuc2V0VGltZW91dDtcbiAgICBnbG9iYWwuc2V0VGltZW91dCA9IGplc3QuZm4oKGNhbGxiYWNrKSA9PiB7XG4gICAgICBjYWxsYmFjaygpO1xuICAgICAgcmV0dXJuIHt9IGFzIGFueTtcbiAgICB9KSBhcyBhbnk7XG4gICAgXG4gICAgYXdhaXQgZXhwZWN0KHdpdGhSZXRyeShtb2NrT3BlcmF0aW9uLCAzKSkucmVqZWN0cy50b1Rocm93KG1vY2tFcnJvcik7XG4gICAgZXhwZWN0KG1vY2tPcGVyYXRpb24pLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygzKTtcbiAgICBcbiAgICAvLyBSZXN0b3JlIHNldFRpbWVvdXRcbiAgICBnbG9iYWwuc2V0VGltZW91dCA9IG9yaWdpbmFsU2V0VGltZW91dDtcbiAgICBqZXN0LnVzZVJlYWxUaW1lcnMoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXNwZWN0IGN1c3RvbSBtYXhSZXRyaWVzIHBhcmFtZXRlcicsIGFzeW5jICgpID0+IHtcbiAgICAvLyBBbHdheXMgZmFpbFxuICAgIGNvbnN0IG1vY2tPcGVyYXRpb24gPSBqZXN0LmZuKCkubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdGYWlsdXJlJykpO1xuICAgIFxuICAgIC8vIE1vY2sgc2V0VGltZW91dCB0byBleGVjdXRlIGltbWVkaWF0ZWx5XG4gICAgamVzdC51c2VGYWtlVGltZXJzKCk7XG4gICAgY29uc3Qgb3JpZ2luYWxTZXRUaW1lb3V0ID0gZ2xvYmFsLnNldFRpbWVvdXQ7XG4gICAgZ2xvYmFsLnNldFRpbWVvdXQgPSBqZXN0LmZuKChjYWxsYmFjaykgPT4ge1xuICAgICAgY2FsbGJhY2soKTtcbiAgICAgIHJldHVybiB7fSBhcyBhbnk7XG4gICAgfSkgYXMgYW55O1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3aXRoUmV0cnkobW9ja09wZXJhdGlvbiwgNSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIEV4cGVjdGVkIHRvIGZhaWxcbiAgICB9XG4gICAgXG4gICAgZXhwZWN0KG1vY2tPcGVyYXRpb24pLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcyg1KTtcbiAgICBcbiAgICAvLyBSZXN0b3JlIHNldFRpbWVvdXRcbiAgICBnbG9iYWwuc2V0VGltZW91dCA9IG9yaWdpbmFsU2V0VGltZW91dDtcbiAgICBqZXN0LnVzZVJlYWxUaW1lcnMoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB1c2UgZXhwb25lbnRpYWwgYmFja29mZiBmb3IgZGVsYXlzIGJldHdlZW4gcmV0cmllcycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2NrT3BlcmF0aW9uID0gamVzdC5mbigpXG4gICAgICAubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignRmFpbHVyZSAxJykpXG4gICAgICAubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignRmFpbHVyZSAyJykpXG4gICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKCdzdWNjZXNzJyk7XG4gICAgXG4gICAgY29uc3QgZGVsYXlzOiBudW1iZXJbXSA9IFtdO1xuICAgIGNvbnN0IG1vY2tTZXRUaW1lb3V0ID0gamVzdC5mbigoY2FsbGJhY2ssIGRlbGF5KSA9PiB7XG4gICAgICBkZWxheXMucHVzaChkZWxheSBhcyBudW1iZXIpO1xuICAgICAgY2FsbGJhY2soKTtcbiAgICAgIHJldHVybiB7fSBhcyBhbnk7XG4gICAgfSk7XG4gICAgXG4gICAgLy8gTW9jayBzZXRUaW1lb3V0IHRvIGNhcHR1cmUgZGVsYXkgdmFsdWVzXG4gICAgamVzdC51c2VGYWtlVGltZXJzKCk7XG4gICAgY29uc3Qgb3JpZ2luYWxTZXRUaW1lb3V0ID0gZ2xvYmFsLnNldFRpbWVvdXQ7XG4gICAgZ2xvYmFsLnNldFRpbWVvdXQgPSBtb2NrU2V0VGltZW91dCBhcyBhbnk7XG4gICAgXG4gICAgYXdhaXQgd2l0aFJldHJ5KG1vY2tPcGVyYXRpb24sIDMsIDEwMCk7XG4gICAgXG4gICAgZXhwZWN0KGRlbGF5cy5sZW5ndGgpLnRvQmUoMik7IC8vIFR3byByZXRyaWVzXG4gICAgZXhwZWN0KGRlbGF5c1swXSkudG9CZSgxMDApOyAgIC8vIEZpcnN0IHJldHJ5OiBiYXNlRGVsYXkgKiAyXjBcbiAgICBleHBlY3QoZGVsYXlzWzFdKS50b0JlKDIwMCk7ICAgLy8gU2Vjb25kIHJldHJ5OiBiYXNlRGVsYXkgKiAyXjFcbiAgICBcbiAgICAvLyBSZXN0b3JlIHNldFRpbWVvdXRcbiAgICBnbG9iYWwuc2V0VGltZW91dCA9IG9yaWdpbmFsU2V0VGltZW91dDtcbiAgICBqZXN0LnVzZVJlYWxUaW1lcnMoKTtcbiAgfSk7XG59KTsiXX0=