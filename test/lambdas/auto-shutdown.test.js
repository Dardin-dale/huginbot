"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const auto_shutdown_1 = require("../../lib/lambdas/auto-shutdown");
const aws_sdk_client_mock_1 = require("aws-sdk-client-mock");
const client_ec2_1 = require("@aws-sdk/client-ec2");
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
const ec2Mock = (0, aws_sdk_client_mock_1.mockClient)(client_ec2_1.EC2Client);
const eventBridgeMock = (0, aws_sdk_client_mock_1.mockClient)(client_eventbridge_1.EventBridgeClient);
describe('Auto-Shutdown Lambda', () => {
    beforeEach(() => {
        ec2Mock.reset();
        eventBridgeMock.reset();
        process.env.VALHEIM_INSTANCE_ID = 'i-1234567890abcdef0';
        process.env.MIN_UPTIME_MINUTES = '10';
    });
    afterEach(() => {
        delete process.env.VALHEIM_INSTANCE_ID;
        delete process.env.MIN_UPTIME_MINUTES;
    });
    const mockSNSEvent = {
        Records: [{
                EventSource: 'aws:sns',
                EventVersion: '1.0',
                EventSubscriptionArn: 'arn:aws:sns:us-east-1:123456789012:test-topic:12345678-1234-1234-1234-123456789012',
                Sns: {
                    Type: 'Notification',
                    MessageId: '12345678-1234-1234-1234-123456789012',
                    TopicArn: 'arn:aws:sns:us-east-1:123456789012:test-topic',
                    Subject: 'ALARM: PlayerInactivityAlarm',
                    Message: JSON.stringify({
                        AlarmName: 'PlayerInactivityAlarm',
                        NewStateValue: 'ALARM',
                        Trigger: {
                            MetricName: 'PlayerCount',
                            Namespace: 'ValheimServer',
                            Statistic: 'Maximum',
                            Unit: null,
                            Dimensions: [],
                            Period: 300,
                            EvaluationPeriods: 2,
                            ComparisonOperator: 'LessThanOrEqualToThreshold',
                            Threshold: 0.0
                        }
                    }),
                    Timestamp: new Date().toISOString(),
                    SignatureVersion: '1',
                    Signature: 'test-signature',
                    SigningCertUrl: 'https://sns.us-east-1.amazonaws.com/SimpleNotificationService-test.pem',
                    UnsubscribeUrl: 'https://sns.us-east-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=test',
                    MessageAttributes: {}
                }
            }]
    };
    const mockContext = {
        callbackWaitsForEmptyEventLoop: false,
        functionName: 'auto-shutdown-test',
        functionVersion: '1',
        invokedFunctionArn: 'arn:aws:lambda:us-east-1:123456789012:function:auto-shutdown-test',
        memoryLimitInMB: '128',
        awsRequestId: '12345678-1234-1234-1234-123456789012',
        logGroupName: '/aws/lambda/auto-shutdown-test',
        logStreamName: '2024/01/01/[$LATEST]abcdef1234567890',
        getRemainingTimeInMillis: () => 30000,
        done: () => { },
        fail: () => { },
        succeed: () => { }
    };
    it('should stop instance when it meets uptime requirements', async () => {
        const launchTime = new Date(Date.now() - 15 * 60 * 1000); // 15 minutes ago
        ec2Mock.on(client_ec2_1.DescribeInstancesCommand).resolves({
            Reservations: [{
                    Instances: [{
                            InstanceId: 'i-1234567890abcdef0',
                            State: { Name: 'running' },
                            LaunchTime: launchTime
                        }]
                }]
        });
        ec2Mock.on(client_ec2_1.StopInstancesCommand).resolves({});
        eventBridgeMock.on(client_eventbridge_1.PutEventsCommand).resolves({});
        await (0, auto_shutdown_1.handler)(mockSNSEvent, mockContext);
        expect(ec2Mock.commandCalls(client_ec2_1.DescribeInstancesCommand)).toHaveLength(1);
        expect(ec2Mock.commandCalls(client_ec2_1.StopInstancesCommand)).toHaveLength(1);
        expect(eventBridgeMock.commandCalls(client_eventbridge_1.PutEventsCommand)).toHaveLength(1);
        const stopCall = ec2Mock.commandCalls(client_ec2_1.StopInstancesCommand)[0];
        expect(stopCall.args[0].input.InstanceIds).toEqual(['i-1234567890abcdef0']);
    });
    it('should not stop instance if uptime is less than minimum', async () => {
        const launchTime = new Date(Date.now() - 5 * 60 * 1000); // 5 minutes ago
        ec2Mock.on(client_ec2_1.DescribeInstancesCommand).resolves({
            Reservations: [{
                    Instances: [{
                            InstanceId: 'i-1234567890abcdef0',
                            State: { Name: 'running' },
                            LaunchTime: launchTime
                        }]
                }]
        });
        await (0, auto_shutdown_1.handler)(mockSNSEvent, mockContext);
        expect(ec2Mock.commandCalls(client_ec2_1.DescribeInstancesCommand)).toHaveLength(1);
        expect(ec2Mock.commandCalls(client_ec2_1.StopInstancesCommand)).toHaveLength(0);
        expect(eventBridgeMock.commandCalls(client_eventbridge_1.PutEventsCommand)).toHaveLength(0);
    });
    it('should not stop instance if it is not running', async () => {
        ec2Mock.on(client_ec2_1.DescribeInstancesCommand).resolves({
            Reservations: [{
                    Instances: [{
                            InstanceId: 'i-1234567890abcdef0',
                            State: { Name: 'stopped' },
                            LaunchTime: new Date(Date.now() - 15 * 60 * 1000)
                        }]
                }]
        });
        await (0, auto_shutdown_1.handler)(mockSNSEvent, mockContext);
        expect(ec2Mock.commandCalls(client_ec2_1.DescribeInstancesCommand)).toHaveLength(1);
        expect(ec2Mock.commandCalls(client_ec2_1.StopInstancesCommand)).toHaveLength(0);
        expect(eventBridgeMock.commandCalls(client_eventbridge_1.PutEventsCommand)).toHaveLength(0);
    });
    it('should handle missing instance gracefully', async () => {
        ec2Mock.on(client_ec2_1.DescribeInstancesCommand).resolves({
            Reservations: []
        });
        await (0, auto_shutdown_1.handler)(mockSNSEvent, mockContext);
        expect(ec2Mock.commandCalls(client_ec2_1.DescribeInstancesCommand)).toHaveLength(1);
        expect(ec2Mock.commandCalls(client_ec2_1.StopInstancesCommand)).toHaveLength(0);
        expect(eventBridgeMock.commandCalls(client_eventbridge_1.PutEventsCommand)).toHaveLength(0);
    });
    it('should handle missing environment variable', async () => {
        delete process.env.VALHEIM_INSTANCE_ID;
        await (0, auto_shutdown_1.handler)(mockSNSEvent, mockContext);
        expect(ec2Mock.commandCalls(client_ec2_1.DescribeInstancesCommand)).toHaveLength(0);
        expect(ec2Mock.commandCalls(client_ec2_1.StopInstancesCommand)).toHaveLength(0);
        expect(eventBridgeMock.commandCalls(client_eventbridge_1.PutEventsCommand)).toHaveLength(0);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0by1zaHV0ZG93bi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXV0by1zaHV0ZG93bi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUVBQTBEO0FBRTFELDZEQUFpRDtBQUNqRCxvREFBZ0c7QUFDaEcsb0VBQWtGO0FBRWxGLE1BQU0sT0FBTyxHQUFHLElBQUEsZ0NBQVUsRUFBQyxzQkFBUyxDQUFDLENBQUM7QUFDdEMsTUFBTSxlQUFlLEdBQUcsSUFBQSxnQ0FBVSxFQUFDLHNDQUFpQixDQUFDLENBQUM7QUFFdEQsUUFBUSxDQUFDLHNCQUFzQixFQUFFLEdBQUcsRUFBRTtJQUNwQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2hCLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN4QixPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixHQUFHLHFCQUFxQixDQUFDO1FBQ3hELE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO0lBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQztRQUN2QyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUM7SUFDeEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLFlBQVksR0FBYTtRQUM3QixPQUFPLEVBQUUsQ0FBQztnQkFDUixXQUFXLEVBQUUsU0FBUztnQkFDdEIsWUFBWSxFQUFFLEtBQUs7Z0JBQ25CLG9CQUFvQixFQUFFLG9GQUFvRjtnQkFDMUcsR0FBRyxFQUFFO29CQUNILElBQUksRUFBRSxjQUFjO29CQUNwQixTQUFTLEVBQUUsc0NBQXNDO29CQUNqRCxRQUFRLEVBQUUsK0NBQStDO29CQUN6RCxPQUFPLEVBQUUsOEJBQThCO29CQUN2QyxPQUFPLEVBQUUsSUFBSSxDQUFD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WUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLDRDQUE0QyxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzFELE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQztRQUV2QyxNQUFNLElBQUEsdUJBQU8sRUFBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFFekMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMscUNBQXdCLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2RSxNQUFNLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxpQ0FBb0IsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25FLE1BQU0sQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLHFDQUFnQixDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekUsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGhhbmRsZXIgfSBmcm9tICcuLi8uLi9saWIvbGFtYmRhcy9hdXRvLXNodXRkb3duJztcbmltcG9ydCB7IFNOU0V2ZW50LCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBtb2NrQ2xpZW50IH0gZnJvbSAnYXdzLXNkay1jbGllbnQtbW9jayc7XG5pbXBvcnQgeyBFQzJDbGllbnQsIERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCwgU3RvcEluc3RhbmNlc0NvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZWMyJztcbmltcG9ydCB7IEV2ZW50QnJpZGdlQ2xpZW50LCBQdXRFdmVudHNDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWV2ZW50YnJpZGdlJztcblxuY29uc3QgZWMyTW9jayA9IG1vY2tDbGllbnQoRUMyQ2xpZW50KTtcbmNvbnN0IGV2ZW50QnJpZGdlTW9jayA9IG1vY2tDbGllbnQoRXZlbnRCcmlkZ2VDbGllbnQpO1xuXG5kZXNjcmliZSgnQXV0by1TaHV0ZG93biBMYW1iZGEnLCAoKSA9PiB7XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGVjMk1vY2sucmVzZXQoKTtcbiAgICBldmVudEJyaWRnZU1vY2sucmVzZXQoKTtcbiAgICBwcm9jZXNzLmVudi5WQUxIRUlNX0lOU1RBTkNFX0lEID0gJ2ktMTIzNDU2Nzg5MGFiY2RlZjAnO1xuICAgIHByb2Nlc3MuZW52Lk1JTl9VUFRJTUVfTUlOVVRFUyA9ICcxMCc7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgZGVsZXRlIHByb2Nlc3MuZW52LlZBTEhFSU1fSU5TVEFOQ0VfSUQ7XG4gICAgZGVsZXRlIHByb2Nlc3MuZW52Lk1JTl9VUFRJTUVfTUlOVVRFUztcbiAgfSk7XG5cbiAgY29uc3QgbW9ja1NOU0V2ZW50OiBTTlNFdmVudCA9IHtcbiAgICBSZWNvcmRzOiBbe1xuICAgICAgRXZlbnRTb3VyY2U6ICdhd3M6c25zJyxcbiAgICAgIEV2ZW50VmVyc2lvbjogJzEuMCcsXG4gICAgICBFdmVudFN1YnNjcmlwdGlvbkFybjogJ2Fybjphd3M6c25zOnVzLWVhc3QtMToxMjM0NTY3ODkwMTI6dGVzdC10b3BpYzoxMjM0NTY3OC0xMjM0LTEyMzQtMTIzNC0xMjM0NTY3ODkwMTInLFxuICAgICAgU25zOiB7XG4gICAgICAgIFR5cGU6ICdOb3RpZmljYXRpb24nLFxuICAgICAgICBNZXNzYWdlSWQ6ICcxMjM0NTY3OC0xMjM0LTEyMzQtMTIzNC0xMjM0NTY3ODkwMTInLFxuICAgICAgICBUb3BpY0FybjogJ2Fybjphd3M6c25zOnVzLWVhc3QtMToxMjM0NTY3ODkwMTI6dGVzdC10b3BpYycsXG4gICAgICAgIFN1YmplY3Q6ICdBTEFSTTogUGxheWVySW5hY3Rpdml0eUFsYXJtJyxcbiAgICAgICAgTWVzc2FnZTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIEFsYXJtTmFtZTogJ1BsYXllckluYWN0aXZpdHlBbGFybScsXG4gICAgICAgICAgTmV3U3RhdGVWYWx1ZTogJ0FMQVJNJyxcbiAgICAgICAgICBUcmlnZ2VyOiB7XG4gICAgICAgICAgICBNZXRyaWNOYW1lOiAnUGxheWVyQ291bnQnLFxuICAgICAgICAgICAgTmFtZXNwYWNlOiAnVmFsaGVpbVNlcnZlcicsXG4gICAgICAgICAgICBTdGF0aXN0aWM6ICdNYXhpbXVtJyxcbiAgICAgICAgICAgIFVuaXQ6IG51bGwsXG4gICAgICAgICAgICBEaW1lbnNpb25zOiBbXSxcbiAgICAgICAgICAgIFBlcmlvZDogMzAwLFxuICAgICAgICAgICAgRXZhbHVhdGlvblBlcmlvZHM6IDIsXG4gICAgICAgICAgICBDb21wYXJpc29uT3BlcmF0b3I6ICdMZXNzVGhhbk9yRXF1YWxUb1RocmVzaG9sZCcsXG4gICAgICAgICAgICBUaHJlc2hvbGQ6IDAuMFxuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICAgIFRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICBTaWduYXR1cmVWZXJzaW9uOiAnMScsXG4gICAgICAgIFNpZ25hdHVyZTogJ3Rlc3Qtc2lnbmF0dXJlJyxcbiAgICAgICAgU2lnbmluZ0NlcnRVcmw6ICdodHRwczovL3Nucy51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS9TaW1wbGVOb3RpZmljYXRpb25TZXJ2aWNlLXRlc3QucGVtJyxcbiAgICAgICAgVW5zdWJzY3JpYmVVcmw6ICdodHRwczovL3Nucy51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS8/QWN0aW9uPVVuc3Vic2NyaWJlJlN1YnNjcmlwdGlvbkFybj10ZXN0JyxcbiAgICAgICAgTWVzc2FnZUF0dHJpYnV0ZXM6IHt9XG4gICAgICB9XG4gICAgfV1cbiAgfTtcblxuICBjb25zdCBtb2NrQ29udGV4dDogQ29udGV4dCA9IHtcbiAgICBjYWxsYmFja1dhaXRzRm9yRW1wdHlFdmVudExvb3A6IGZhbHNlLFxuICAgIGZ1bmN0aW9uTmFtZTogJ2F1dG8tc2h1dGRvd24tdGVzdCcsXG4gICAgZnVuY3Rpb25WZXJzaW9uOiAnMScsXG4gICAgaW52b2tlZEZ1bmN0aW9uQXJuOiAnYXJuOmF3czpsYW1iZGE6dXMtZWFzdC0xOjEyMzQ1Njc4OTAxMjpmdW5jdGlvbjphdXRvLXNodXRkb3duLXRlc3QnLFxuICAgIG1lbW9yeUxpbWl0SW5NQjogJzEyOCcsXG4gICAgYXdzUmVxdWVzdElkOiAnMTIzNDU2NzgtMTIzNC0xMjM0LTEyMzQtMTIzNDU2Nzg5MDEyJyxcbiAgICBsb2dHcm91cE5hbWU6ICcvYXdzL2xhbWJkYS9hdXRvLXNodXRkb3duLXRlc3QnLFxuICAgIGxvZ1N0cmVhbU5hbWU6ICcyMDI0LzAxLzAxL1skTEFURVNUXWFiY2RlZjEyMzQ1Njc4OTAnLFxuICAgIGdldFJlbWFpbmluZ1RpbWVJbk1pbGxpczogKCkgPT4gMzAwMDAsXG4gICAgZG9uZTogKCkgPT4ge30sXG4gICAgZmFpbDogKCkgPT4ge30sXG4gICAgc3VjY2VlZDogKCkgPT4ge31cbiAgfTtcblxuICBpdCgnc2hvdWxkIHN0b3AgaW5zdGFuY2Ugd2hlbiBpdCBtZWV0cyB1cHRpbWUgcmVxdWlyZW1lbnRzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGxhdW5jaFRpbWUgPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMTUgKiA2MCAqIDEwMDApOyAvLyAxNSBtaW51dGVzIGFnb1xuXG4gICAgZWMyTW9jay5vbihEZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpLnJlc29sdmVzKHtcbiAgICAgIFJlc2VydmF0aW9uczogW3tcbiAgICAgICAgSW5zdGFuY2VzOiBbe1xuICAgICAgICAgIEluc3RhbmNlSWQ6ICdpLTEyMzQ1Njc4OTBhYmNkZWYwJyxcbiAgICAgICAgICBTdGF0ZTogeyBOYW1lOiAncnVubmluZycgfSxcbiAgICAgICAgICBMYXVuY2hUaW1lOiBsYXVuY2hUaW1lXG4gICAgICAgIH1dXG4gICAgICB9XVxuICAgIH0pO1xuXG4gICAgZWMyTW9jay5vbihTdG9wSW5zdGFuY2VzQ29tbWFuZCkucmVzb2x2ZXMoe30pO1xuICAgIGV2ZW50QnJpZGdlTW9jay5vbihQdXRFdmVudHNDb21tYW5kKS5yZXNvbHZlcyh7fSk7XG5cbiAgICBhd2FpdCBoYW5kbGVyKG1vY2tTTlNFdmVudCwgbW9ja0NvbnRleHQpO1xuXG4gICAgZXhwZWN0KGVjMk1vY2suY29tbWFuZENhbGxzKERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCkpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICBleHBlY3QoZWMyTW9jay5jb21tYW5kQ2FsbHMoU3RvcEluc3RhbmNlc0NvbW1hbmQpKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgZXhwZWN0KGV2ZW50QnJpZGdlTW9jay5jb21tYW5kQ2FsbHMoUHV0RXZlbnRzQ29tbWFuZCkpLnRvSGF2ZUxlbmd0aCgxKTtcblxuICAgIGNvbnN0IHN0b3BDYWxsID0gZWMyTW9jay5jb21tYW5kQ2FsbHMoU3RvcEluc3RhbmNlc0NvbW1hbmQpWzBdO1xuICAgIGV4cGVjdChzdG9wQ2FsbC5hcmdzWzBdLmlucHV0Lkluc3RhbmNlSWRzKS50b0VxdWFsKFsnaS0xMjM0NTY3ODkwYWJjZGVmMCddKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBub3Qgc3RvcCBpbnN0YW5jZSBpZiB1cHRpbWUgaXMgbGVzcyB0aGFuIG1pbmltdW0nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbGF1bmNoVGltZSA9IG5ldyBEYXRlKERhdGUubm93KCkgLSA1ICogNjAgKiAxMDAwKTsgLy8gNSBtaW51dGVzIGFnb1xuXG4gICAgZWMyTW9jay5vbihEZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpLnJlc29sdmVzKHtcbiAgICAgIFJlc2VydmF0aW9uczogW3tcbiAgICAgICAgSW5zdGFuY2VzOiBbe1xuICAgICAgICAgIEluc3RhbmNlSWQ6ICdpLTEyMzQ1Njc4OTBhYmNkZWYwJyxcbiAgICAgICAgICBTdGF0ZTogeyBOYW1lOiAncnVubmluZycgfSxcbiAgICAgICAgICBMYXVuY2hUaW1lOiBsYXVuY2hUaW1lXG4gICAgICAgIH1dXG4gICAgICB9XVxuICAgIH0pO1xuXG4gICAgYXdhaXQgaGFuZGxlcihtb2NrU05TRXZlbnQsIG1vY2tDb250ZXh0KTtcblxuICAgIGV4cGVjdChlYzJNb2NrLmNvbW1hbmRDYWxscyhEZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgZXhwZWN0KGVjMk1vY2suY29tbWFuZENhbGxzKFN0b3BJbnN0YW5jZXNDb21tYW5kKSkudG9IYXZlTGVuZ3RoKDApO1xuICAgIGV4cGVjdChldmVudEJyaWRnZU1vY2suY29tbWFuZENhbGxzKFB1dEV2ZW50c0NvbW1hbmQpKS50b0hhdmVMZW5ndGgoMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgbm90IHN0b3AgaW5zdGFuY2UgaWYgaXQgaXMgbm90IHJ1bm5pbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgZWMyTW9jay5vbihEZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpLnJlc29sdmVzKHtcbiAgICAgIFJlc2VydmF0aW9uczogW3tcbiAgICAgICAgSW5zdGFuY2VzOiBbe1xuICAgICAgICAgIEluc3RhbmNlSWQ6ICdpLTEyMzQ1Njc4OTBhYmNkZWYwJyxcbiAgICAgICAgICBTdGF0ZTogeyBOYW1lOiAnc3RvcHBlZCcgfSxcbiAgICAgICAgICBMYXVuY2hUaW1lOiBuZXcgRGF0ZShEYXRlLm5vdygpIC0gMTUgKiA2MCAqIDEwMDApXG4gICAgICAgIH1dXG4gICAgICB9XVxuICAgIH0pO1xuXG4gICAgYXdhaXQgaGFuZGxlcihtb2NrU05TRXZlbnQsIG1vY2tDb250ZXh0KTtcblxuICAgIGV4cGVjdChlYzJNb2NrLmNvbW1hbmRDYWxscyhEZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgZXhwZWN0KGVjMk1vY2suY29tbWFuZENhbGxzKFN0b3BJbnN0YW5jZXNDb21tYW5kKSkudG9IYXZlTGVuZ3RoKDApO1xuICAgIGV4cGVjdChldmVudEJyaWRnZU1vY2suY29tbWFuZENhbGxzKFB1dEV2ZW50c0NvbW1hbmQpKS50b0hhdmVMZW5ndGgoMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaGFuZGxlIG1pc3NpbmcgaW5zdGFuY2UgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICBlYzJNb2NrLm9uKERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCkucmVzb2x2ZXMoe1xuICAgICAgUmVzZXJ2YXRpb25zOiBbXVxuICAgIH0pO1xuXG4gICAgYXdhaXQgaGFuZGxlcihtb2NrU05TRXZlbnQsIG1vY2tDb250ZXh0KTtcblxuICAgIGV4cGVjdChlYzJNb2NrLmNvbW1hbmRDYWxscyhEZXNjcmliZUluc3RhbmNlc0NvbW1hbmQpKS50b0hhdmVMZW5ndGgoMSk7XG4gICAgZXhwZWN0KGVjMk1vY2suY29tbWFuZENhbGxzKFN0b3BJbnN0YW5jZXNDb21tYW5kKSkudG9IYXZlTGVuZ3RoKDApO1xuICAgIGV4cGVjdChldmVudEJyaWRnZU1vY2suY29tbWFuZENhbGxzKFB1dEV2ZW50c0NvbW1hbmQpKS50b0hhdmVMZW5ndGgoMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaGFuZGxlIG1pc3NpbmcgZW52aXJvbm1lbnQgdmFyaWFibGUnLCBhc3luYyAoKSA9PiB7XG4gICAgZGVsZXRlIHByb2Nlc3MuZW52LlZBTEhFSU1fSU5TVEFOQ0VfSUQ7XG5cbiAgICBhd2FpdCBoYW5kbGVyKG1vY2tTTlNFdmVudCwgbW9ja0NvbnRleHQpO1xuXG4gICAgZXhwZWN0KGVjMk1vY2suY29tbWFuZENhbGxzKERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCkpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgICBleHBlY3QoZWMyTW9jay5jb21tYW5kQ2FsbHMoU3RvcEluc3RhbmNlc0NvbW1hbmQpKS50b0hhdmVMZW5ndGgoMCk7XG4gICAgZXhwZWN0KGV2ZW50QnJpZGdlTW9jay5jb21tYW5kQ2FsbHMoUHV0RXZlbnRzQ29tbWFuZCkpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgfSk7XG59KTsiXX0=